 Pontos crÃ­ticos que precisam de ajuste:
1ï¸âƒ£ Valor inconsistente na API vs SDK Mercado Pago
No createPixPayment, vocÃª converte:

ts
Copiar
Editar
const transactionAmount = PLAN_PRICES[data.plan] / 100;
Isso envia R$ 1,00 para o Mercado Pago para plano test, mas no banco vocÃª salva em centavos.
Se o webhook espera valores em centavos para determinar o plano pelo valor pago, isso vai quebrar a lÃ³gica.

âœ… CorreÃ§Ã£o:
Padronize para enviar e salvar sempre em centavos. Ou adapte o webhook pra comparar float em vez de centavos.

2ï¸âƒ£ Webhook salva pagamento novo em vez de atualizar o existente
No webhook vocÃª faz:

ts
Copiar
Editar
await storage.createPayment({
  userId: userId,
  mercadoPagoId: paymentId,
  ...
});
â¡ï¸ Isso gera duplicatas. O correto seria fazer um updatePaymentByReference onde externalReference ou mercadoPagoId jÃ¡ existisse.

âœ… CorreÃ§Ã£o:
Adicione um mÃ©todo updatePaymentStatusByReference e use isso aqui:

ts
Copiar
Editar
await storage.updatePaymentStatusByReference(paymentInfo.external_reference, {
  status: 'approved',
  mercadoPagoId: paymentId,
  transactionAmount: transactionAmountCents,
  ...
});
3ï¸âƒ£ Webhook sem autenticaÃ§Ã£o da assinatura
No webhook:

ts
Copiar
Editar
if (!validateWebhookSignature(...)) { return 401 }
O validateWebhookSignature atualmente retorna sempre true.

âœ… CorreÃ§Ã£o:
Implemente a verificaÃ§Ã£o baseada na documentaÃ§Ã£o oficial.

4ï¸âƒ£ InconsistÃªncia no endpoint de criaÃ§Ã£o
VocÃª tem dois endpoints:

/api/payments/create-pix

/api/payments/pix/create

Ambos fazem a mesma coisa. Isso Ã© redundante e pode confundir no frontend.

âœ… CorreÃ§Ã£o:
Centralize e mantenha apenas um endpoint.

ğŸ“Œ Melhorias sugeridas:
ğŸ”’ Habilitar assinatura de webhook real

ğŸ“Š Adicionar status de â€œexpiredâ€ no banco se o pagamento nÃ£o for aprovado em 30min (usando cronjob ou cleanup route)

ğŸ“ Logar o ID de pagamento Mercado Pago direto ao salvar

ğŸ§¼ Remover payment.create se preference.create falhar (hoje isso fica sem retorno)

âœ… ConclusÃ£o:
Teu fluxo estÃ¡ muito bem arquitetado, mas esses 4 pontos acima sÃ£o cruciais pra que o sistema:

Funcione sem falha em ambientes reais

Evite duplicaÃ§Ã£o de pagamentos

Tenha validaÃ§Ã£o de seguranÃ§a correta no webhook

Use um Ãºnico endpoint consistente no frontend e backend